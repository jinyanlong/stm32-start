

#### 一、 概述

​	本协议同时考虑低频和2.4G 同时配合工作,标签平时处在静默状态,当发现低频信号时，依据低频信号的内容做出响应的动作。
​	在某些情况下,2.4G的接收被开启，此时可以接收2.4G的指令，并执行相应的操作。为确保标签处在低功耗状态，2.4G指令操作完成后，必须很快重新进入静默状态

#### 二、低频激活器

##### 2.1   概述

​	低频激活器每次发送一个2B的数据,如果最高位为0,这个数据表示天线编号, 最高位为1，表示需要执行特殊指令。
| 15   | 14,13,12 | 11~0     |
| ---- | -------- | -------- |
| 0    | 天线类型 | 天线编号 |
| 1    | 指令类型 | 指令码   |


​	2.4G 指令类别:
|  说明  | 类别码 |备注|
| ---- | -------- |----|
| 标签->设备(定位消息)| 0xA0 |仅使用<卡号>|
| 标签->设备(低频应答)| 0xA1 |同时发送CPU_ID和<卡号>做为自身地址|
| 设备->标签(指令)    | 0xA2|用CPU_ID为地址, 标签卡号一般可以忽略|
| 标签->设备(回应)    | 0xA3|用CPU_ID为地址, 标签卡号仅用于参考|
| 消息    | 0xA4|默认广播|

 注： 标签有两个ID,一个是CPU_ID,一个是卡号, 协议中2个都会传输,但实际使用的是CPU_ID, 卡号不用于地址有效性判断




##### 2.2  定位系统

​	激活器在固定位置，连续发送定位信息(2B), 最高bit=0, 次高3bits为天线类型,其余12bits 表示天线编号,所以天线编号范围在 0000~7FFF。

​	天线类型:

```
- 0  ~测试天线

  0XXX  表示测试天线ID

- 1,2,3  ~门禁

  默认 0x1XXX 表示内测,0x2XXX表示外侧, 0x3XXX用来同时激活内/外测天线

- 4 ~ 跑圈

  0x4000~ 0x4009  为一组

  0x4010~ 0x4019  为二组

  ...

  0x4990~0x4999

- 5~7 保留
```
​	标签收到激活器的定位信息后,通过2.4G连续发送5次(默认值) 在线通知,当定位信息丢失3秒后,发送离线通知:

```
内容长度(1B)+信道(1B)+指令类别码(1B)+标签状态(1B)+系统ID(4B)+卡号(4B)+设备时刻(4B)+计步数量(4B)+附加属性(...)+[天线ID(2B)+激活时刻(2B)+离线时刻(2B)]*N
- 内容长度(1B)
	由硬件自动生成,为保证可靠性,协议中会保留历史记录,最大10条记录, 记录总长为(20+ 6*7)=62B
- 信道(1B)
	由硬件自动生成
- 指令类别码(1B)
	固定为0xA0
- 标签状态(1B)
	bit7    表示低电压报警信号
	bit6    表示代理商编号是否有效(最新版总是为1)
	bit5    0~CPU_ID(未初始化)  1~流水码(初始化完成)
	bit4    保留
	bit3~0  附加属性长度(4字节为单位)
- 卡号(4B)
	初始化之前用CPU_ID,初始化之后用流水码(参见标识位bit1)
- 设备时刻
	标签启动以来的时间差,时间单位10ms(最大值可超过1年,标签理论上连续工作时间为1年)
- 计步数量
	没有计步数据时保留为0
- 附加属性
	后面的区域以后用于扩充心率、体温等信息
- 天线ID
	协议中借用天线ID的最高位为1表示在线, 0表示已离线
	ID=0x3XXX的天线会被分解成0x1XXX和0x2XXX两个天线
    同一个天线ID只会出现一次, 新记录会覆盖旧记录
    短时间内出现的天线ID会被合并,直到超时离线
- 激活时刻
	进入天线的时刻,用时间差表示,时间单位是10ms,这个时刻加上设备时刻才是实际的时间。2字节允许的最大时差是约10分钟, 所以不能记录超过10分钟的历史记录,所以当在线时间过长,这个时刻会被更新(默认1分钟)。
- 离线时刻
	离开天线的时刻(天线ID的最高位=0时有效),用时间差表示,时间单位是10ms,这个时刻加上设备时刻才是实际的时间
```



##### 2.3  指令系统

###### 2.3.1  低频天线自适应校准

- 设备发送:

  模式: 低频

  ```
  数据:  0x80XX
  
  XX是校准ID,标签发现相同的ID,不会重复执行校准
  ```

- 标签回应

  模式: 2.4G

  ```
  [内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+卡号(4B)+CPU_ID(4B)+天线ID(2B)+X轴调整值+Y轴调整值+Z轴调整值
  - 指令类别码
  	0xA1
  - 指令码
  	0x80(必须与低频指令相同)
  - 卡号
  	卡号为0表示,尚未初始化
  - CPU_ID
  	芯片序号
  - 调整时刻
  - 天线ID
   	激活天线编号
  - X，Y轴调整值
   	0~31
  
  
  ```

  注: 收到校准指令后，标签立刻返回上一次的校准值，然后启动校准。一定要注意，并不会立刻返回校准完成后的值 ，因为校准时间较长，不可能立刻返回。


###### 2.3.2  读取标签属性

- 设备发送:

  模式: 低频发送(单次发送)

  ```
  数据:  0x81XX (XX 表示属性ID)
  属性ID:
  - 0 		标签状态(1B)
  - 1     	设备编号(4B,流水码)
  - 3			版本号(2B)
  - 4			型号(2B)
  - 5     	CPUID散列值(4B)
  - 6     	注册时间(4B)+当前时间(4B)
  - 7     	SYSTEMID(4B)
  - 8     	PING间隔(2B,10ms)
  - 9     	离线间隔(2B,10ms)
  - 0x0A     	重发次数(1B)
  - 0x0B     	低频配置信息=天线号(2B)+r_x(1B)+r_y(1B)
  
  - 0x10...    计步、温度、湿度、心率(等) ...
  ```

- 标签回应

  模式: 2.4G
    ```
  [内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+卡号(4B)+CPU_ID(4B)+属性ID(1B)+属性类型/长度(1B)+属性值(...)
  - 指令类别码(1B)
  	0xA1
  - 指令码
  	0x81(必须与低频指令相同)
  - 属性类型/长度
  	0x00,	  通用(默认)
  	0x01~0x20，表示数据长度
  	0x8X~0xFX，(保留8~F表示类型，X表示长度）
  - 标签状态(1B)
  	bit7    表示低电压报警信号
  	bit6    表示代理商编号是否有效(最新版总是为1)
  	bit5    0~CPU_ID(未初始化)  1~流水码(初始化完成)
  	bit4    保留
  	bit3~0  附加属性长度(4字节为单位)
  - 初始化参数(16)
  流水码(4B)+SYSTEMID(4B)+注册时间(4B,秒)+PING间隔(1B,秒)+离线时间(1B,秒)+重发次数(1B)+保留(1B)
    ```


###### 2.3.3  强制标签进入/退出2.4G接收状态

- 设备发送:

  模式: 低频, 连续发送至少3次

  ```
  数据:  0x82XX
  XX 为超时的秒数，超过这个间隔，标签自动退出设置状态
  特别的0x8200 ，表示要求标签立刻退出设置状态
  ```

- 标签回应

  模式: 2.4G

  ```
  [内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+CPU_ID(4B)+卡号(4B)
  - 指令类别码(1B)
  	0xA1
  - 指令码(1B)
  	0x82
  ```

###### 2.3.4  强制标签进入RSSI测试信号状态

- 设备发送:

  模式: 低频

  ```
  数据:  0x83XX
  XX 为超时的秒数，超过这个间隔，标签自动退出测试状态
  ```

- 标签回应

  模式: 2.4G (回应之前，标签会先执行一次RSSI测试) 

  ```
  [内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+CPU_ID(4B)+卡号(4B)+设备ID(4B)+RSSI-TX(4B)+RSSI-RX(4B)
  - 指令类别码(1B)
  	0xA1
  - 指令码(1B)
  	0x83
  ```

###### 2.3.5  格式化指令(Init)

- 设备发送:
  模式: 2.4G
```
[内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+CPU_ID(4B)+卡号(4B)+密码(8B)+初始化参数(16B)
- 指令类别码(1B)
	0xA2
- 指令码
	0x00
- 密码(8B)+初始化参数(16B)
1. "FOFIAXYK"   执行格式化
+SYSTEMID(4B)+注册时间(4B,秒)+PING间隔(1B,秒)+离线时间(1B,秒)+重发次数(1B)+保留(1B)
2. "FOFIATIM"   设置时钟
设备时间(4B)
3. "FOFIASCH"   修改学校编号
学校编号(2B)

注： 协议头中的系统ID可以设置为0,这样就不检查系统ID,后面的指令均类似
```
- 标签回应:
```
[内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+CPU_ID(4B)+卡号(4B)+初始化参数(nB)
- 指令类别码(1B)
	0xA3
- 指令码
	0x00(必须与指令相同)
- 初始化参数(16B)
流水码(4B)+SYSTEMID(4B)+注册时间(4B,秒)+PING间隔(1B,秒)+离线时间(1B,秒)+重发次数(1B)+保留(1B)
```

###### 2.3.6  参数设置(setAttr)
​	保留
###### 2.3.7  参数读取(getAttr)

- 设备发送:
  模式: 2.4G
```
[内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+CPU_ID(4B)+保留(4B)+属性ID(1B)+保留(1B)
- 指令类别码(1B)
	0xA2
- 指令码
	0x02
- 初始化参数(16B)
流水码(4B)+SYSTEMID(4B)+注册时间(4B,秒)+PING间隔(1B,秒)+离线时间(1B,秒)+重发次数(1B)+保留(1B)
```
- 标签回应:
```
[内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+CPU_ID(4B)+卡号(4B)+属性ID(1B)+属性类型/长度(1B)+属性值(...)
- 指令类别码(1B)
	0xA3
- 指令码
	0x02(必须与指令相同)
```



###### 2.3.8  RSSI测试指令

- 标签发送:
  模式: 2.4G
```
[内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+保留(8B,必须为0)+CPU_ID(4B)+标签ID(4B)
- 指令类别码(1B)
	0xA4
- 指令码
	0x00
```
- 设备发送:

```
[内容长度(1B)+信道(1B)]+指令类别码(1B)+指令码(1B)+系统ID(4B)+标签CPUID(4B)+标签卡号(4B)+设备ID(4B)+RSSI(4B)
- 指令类别码(1B)
	0xA4
- 指令码
	0x01
```
