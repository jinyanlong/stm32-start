源致科技UART通讯协议规范4.0版

#### 一、概述
​	本协议是为RS232/RS485有关产品建立的一套通讯协议规范, 其目标是统一解决主从通讯模式，以及双向异步通讯2种模式。协议格式应尽量简单，同时期望能够兼容之前的协议版本。

#### 二、注意事项:
​	本协议保密级别为中等, 不宜直接对用户公开。可以有选择性的截取部分内容，提供给客户开发使用。

#### 三、修订




#### 四、通信参数
	- 波特率:115200(默认)
	- 起始位:1
	- 数据位:8
	- 奇偶校验位:无
	- 终止位:1

#### 五、协议格式
##### 5.1	帧格式
| STB  | 协议格式|[M-ADDR] | [S-ADDR] |数据包 | CRC8 | ETB  |
| :--: | :----: |:------:| :------:|:----: | :--: | :--: |
|  1B  | 1B     | 4B     | 4B     |  nB   |  1B  |  1B  |
- 起始字符	STB = 0x1A
- 结束字符	ETB = 0x17
- 转义字符	ESC = 0x1B
  0x1B, 0x9A => 0x1A
  0x1B, 0x97 => 0x17
  0x1B, 0x9B => 0x1B
  注: 在STB和ETB之间的中间内容如果出现0x1A,0x17,0x1B都必须转义

- 协议格式:
  - bit7		必须为1
  - bit6		主机地址有效
  - bit5		从机地址有效
  - bit4~0	模式(保留,=00)

- M-ADDR/S-ADDR:
  这两个字段是可选的，依赖于协议中的标志位，在多机通讯/或者需要严格检查设备地址时可选择启用地址标志, 默认等于设备编号(4B),以下地址系统保留:
  - 0x00000000  默认主机地址
  - 0xFFFFFFFF  默认群发地址

##### 5.2	数据包格式
| CLA  | INS  |  LEN  | PARAMS |
| :--: | :--: |  :--: | ------ |
| 指令类别 | 指令码 | 参数长度 | 指令参数 |
| 1B   | 1B   | 2B,可选 | 4B,可选 |

###### 5.2.1	指令类别(CLA)
	bit7,6:
	- 00~指令
	- 01~消息
	- 10~ACK
	- 11~NAK
	bit5~0
	- 0		设备固件指令
	- 1		系统配置指令
	- 8~15   保留
	- 16~63  专用指令

###### 5.2.2	INS
	指令码,从0开始

###### 5.2.3	LEN
	2字节参数长度,考虑到对齐的原因,PARAMS的实际长度可能会大于LEN
###### 5.2.4	PARAMS
	应采用4字节对齐的模式来安排各个字段
	注: 在错误应答中,在参数中存放2字节错误码

##### 5.3	通讯模式切换

​	本协议考虑两种通讯模式，一种是主从模式，用于主机发送指令,设备端应答；另一种是设备主动模式，允许设备主动向主机发送信息。

-	工作模式=>主从模式
    ​	某些设备正常工作时需要处在“随机模式”，此时，主机不能直接向设备发送指令，必须强制设备切换到主从模式。方法如下：
    ​	主机向设备连续发送3个ETB(字符间隔小于10ms),设备在100ms之内向主机回送一个空包(STB+0x80+0xE2+ETB), 表示设备进入主从通讯模式。
-	主从模式=>工作模式
    主机向设备发送一个空包(STB+0x80+0xE2+ETB),设备恢复成主动上传模式
    设备一段时间没有收到设备通讯指令,自动恢复成主动模式


#### 六、指令集
##### 6.1	设备固件指令集(CLA=0x00)
###### 6.1.1	读取属性
    发送:
    	INS=0x00
    	PARAMS=参数ID(4B)
    应答:
    	PARAMS=参数值(nB)
    属性ID:
    	0~设备状态(4B)
    	1~设备id(4B)
    	2~设备通讯地址(4B)
    	3~设备版本号(2B)
    	4~设备类型号(2B)
    	5~CPU序列号(12B)


###### 6.1.2	设置属性(保留)
	发送:
		INS=0x01
		PARAMS=参数ID(4B)+参数值(...B)
	应答:
		PARAMS=(无)

###### 6.1.3	出厂设置
	发送:
		INS=0x02
		PARAMS=格式化标记(8B)+初始属性(8B)
	应答:
		PARAMS=(无)
	格式化标记:
	- "FOFIAFNT"  清除字库区域
	- "FOFIAXYK"  清除数据区域，针对校园卡采集器,初始属性=工作模式(2B)+代理商编号(2B)+保留(4B)
	- "FOFIAALL"  同时清除字库区域和数据区域， 初始属性同上
	说明:
		该操作仅限出厂时，由生产厂家进行设置,目的是区分不同的代理商

###### 6.1.4	蜂鸣器提示
	发送:
		INS=0x03
		PARAMS=序号(1B)+ 模式(1B) + 频率(2B)+次数(2B)+开启延时(2B)+停止延时(2B)
	应答:
		PARAMS=(无)
###### 6.1.5	读FLASH数据(保留)
	发送:
		INS=0x04
		PARAMS=FLASH物理地址(4B)+数据长度(4B)
	应答:
		PARAMS=读到的数据

###### 6.1.6	写FLASH数据(保留)
	发送:
		INS=0x05
		PARAMS=FLASH物理地址(4B)+数据长度(4B)+数据
	应答:
		PARAMS=(无)

###### 6.1.7	readIO
	保留
###### 6.1.8	writeIO
	保留
###### 6.1.9	设备重启
	发送:
		INS=0x08
		PARAMS=(无)
	应答:
		PARAMS=(无)


##### 6.2	系统配置指令集(CLA=0x01)
###### 6.2.1	读取属性
    发送:
    	INS=0x00
    	PARAMS=参数ID(4B)
    应答:
    	PARAMS=参数值(nB)
    属性ID:
    	0~系统ID(4B,只读)
    	1~系统MAC(4B,只读)
    	2~时钟(8B,UTC毫秒数)
    	3~时区(2B,分钟)

###### 6.2.2	设置属性
	发送:
		INS=0x01
		PARAMS=参数ID(4B)+参数值(...B)
	应答:
		PARAMS=(无)
	属性ID:
		2~时钟(8B,UTC毫秒数)
		3~时区(2B,分钟)
###### 6.2.3	系统初始化
	发送:
		INS=0x02
		PARAMS=系统ID(4B)+系统MAC(4B)+系统密码(8B)
	应答:
		PARAMS=系统MAC(4B)
	说明:
		如果输入参数中【系统MAC】=0,那么【系统MAC】在初始化时由设备自动生成,一般用当前时间戳来表示,【设备编号+系统MAC+记录编号】可以保证全球唯一。初始化之前应确保时间准确,这样可以确保系统MAC保持递增。如果输入参数中【系统MAC】!=0, 调用者应自行保证【系统MAC】是递增的，否则应用系统将可能误判记录的先后次序。

###### 6.2.4	建立通讯密钥(保留)
    发送:
    	INS=0x03
    	PARAMS=随机数A(8B)
    应答:
    	PARAMS=随机数B(8B)
    说明:
    	对于要求最严格的场合,通讯需要加密
    	通讯密钥=HASH(设备编号+系统ID+系统密码+随机数A+随机数B)

###### 6.2.5	双向认证(保留)
    发送:
    	INS=0x04
    	PARAMS=认证码B(16B)
    应答:
    	PARAMS=认证码A(16B)
    说明:
    	对于要求比较严格的场合,通讯需要使用双向认证
    	认证码A=HASH(系统密码+随机数A)
    	认证码B=HASH(系统密码+随机数B)

###### 6.2.5	校验密码  

	发送:
		INS=0x05
		PARAMS=系统ID(4B)+系统密码(8B)
	应答:
		PARAMS=(无)
	说明:
		安全等级要求不高的场合下,可以采用口令校验

###### 6.2.6	信息清除
	发送:
		INS=0x06
		PARAMS=标志位(4B)
	应答:
	    PARAMS=(无)
	标志位:
		0~清除所有日志及记录信息,但保留索引值
		1~清除记录信息
		2~清除日志记录信息

##### 6.3	校园卡系统专用指令(CLA=0x11)
​	校园卡采集器，平时在处在设备主动通讯模式下工作，执行主从指令时必须按照 5.3节中描述的方案切换到主从模式
###### 6.3.1	获取应用参数
	发送:
		INS=0x00
		PARAMS=参数ID(4B)
	应答:
		PARAMS=参数值(...B)
	参数ID:
		0~设备名称(UTF-16)
		1~网络主机地址(ASCII)
		2~网络项目路径(ASCII)
		3~APN(ASCII)
		4~网络PING间隔(2B,单位:秒，默认180秒)
		5~标签PING间隔(2B,单位:秒，默认60秒)
		6~标签离线超时间隔(2B,单位：秒,默认3秒)
		7~串口PING间隔(2B,单位:秒)
		8~串口主从模式切换超时值(2B,单位:秒)
###### 6.3.2	设置应用参数
	发送:
		INS=0x01
		PARAMS=参数ID(4B)+参数值(...B)
	应答:
		PARAMS=(无)
	参数ID:
		见6.3.1
###### 6.3.3	获取记录汇总信息
	发送:
		INS=0x02
		PARAMS=(无)
	应答:
		PARAMS= 起始位置(4B)+结束位置(4B)
	说明:
		起始位置从0开始计算, (结束位置-1)是最近的记录位置,如果是0表示无记录
###### 6.3.4	获取记录信息
	说明:
		主从模式下,该指令用于提取备份数据,
		如果记录索引对应的记录已经被删除,那么设备应答信息将返回错误码
	发送:
		INS=0x03
		PARAMS=记录ID(4B)
	应答:
		PARAMS=记录标志(1B)+保留(1B,=00H)+天线ID(2B)+标签编号(4B)+步数(4B)+记录时间(4B,2000年开始的秒数)+触发时间(8B,UTC毫秒数)
	标志:
		bit0~ 离开天线区
		bit7~ 低压报警
###### 6.3.5	PING(设备主动发送)
	设备发送:
		INS=0x10
		PARAMS=设备时钟(8B)+设备编号(4B)+系统ID(4B)+系统MAC(4B)+记录起始ID(4B)+结束ID(4B)+已上传ID(4B)

###### 6.3.6	记录上传(设备主动发送)
	说明:
		设备正常工作时,收到数据后向主机主动发送记录信息,CLA可以处在消息模式/指令模式,如果以指令方式发送,主机收到后必须做出应答, 否则设备将重传之前的记录
	设备发送:
		CLA|=消息模式/指令模式
		INS=0x11·
		PARAMS=设备编号(4B)+系统ID(4B)+系统MAC(4B)+记录ID(4B)+记录标志(1B)+00H+天线ID(2B)+标签编号(4B)+步数(4B)+记录时间(4B,2000年开始的秒数)+触发时间(8B,UTC毫秒数)
	主机应答:
		INS=0x11
		PARAMS=系统MAC(4B)+记录ID(4B)
	记录ID: 从1开始编号, 如果为0，则表示无效记录,主机应答中如果记录ID=0,表示需要设备从头开始发送记录。

##### 6.4	家禽训放采集器专用指令(CLA=0x12)
​	家禽训放采集器，平时在处在设备主动通讯模式下工作，执行主从指令时必须按照 5.3节中描述的方案切换到主从模式, 指令集与"校园卡系统"基本类似，以下仅列出不同之处
###### 6.4.1	获取应用参数

	参数ID:
		0~设备名称(UTF-16)
		1~网络主机地址(ASCII)
		2~网络项目路径(ASCII)
		3~APN(ASCII)
		4~网络PING间隔(2B,单位：秒)
###### 6.4.2	设置应用参数
	见6.4.1
###### 6.4.3	获取记录汇总信息
	见6.3.3
###### 6.4.4	获取记录信息
	参考6.3.4
	记录格式不同...
###### 6.4.5	PING(设备主动发送)
	见6.3.5(略)
###### 6.4.6	记录上传(设备主动发送)
	参考6.3.6
	记录格式不同...



## 6.5	读写器专用指令(CLA=0x13)
###6.5.1:低频发送数据（不需要回复）（读写器）
	说明:
		读写器低频发送数据给标签，不需要等待高频回复
    设备发送:
		INS=0x04
		PARAMS= DATA(2B)
		说明：DATA-为要发送的数据

###6.5.2:低频发送数据（需要回复）（读写器）
	说明:
		读写器低频发送数据给标签，需要等待高频回复
    设备发送:
		INS=0x05
		PARAMS= DATA(2B)
		说明：DATA-为要发送的数据
			
|DATA|说明|返回数据|
|-|-|-|
|低频发送的数据||2.4G返回数据，具体返回数据参考通讯协议（2.4G+低频）|
|0x80XX|天线校准|[内容长度(1B)+信道(1B)]+指令类别码(1B)(0xA1)+指令码(1B)(0x80)+系统ID(4B)+卡号(4B)+CPU_ID(4B)+天线ID(2B)+X轴调整值+Y轴调整值+Z轴调整值(0~31)|
|0x81XX|读取标签属性,XX 表示属性ID.|[内容长度(1B)+信道(1B)]+指令类别码(1B)(0xA1)+指令码(1B)(0x81)+系统ID(4B)+卡号(4B)+CPU_ID(4B)+属性ID(1B)+属性类型/长度(1B)+属性值(...)|
|0x82XX| 强制标签进入/退出2.4G接收状态,XX 为超时的秒数，超过这个间隔，标签自动退出设置状态|[内容长度(1B)+信道(1B)]+指令类别码(1B)(0xA1)+指令码(1B)(0x82)+系统ID(4B)+CPU_ID(4B)+卡号(4B)|


	属性id说明：
	数据:  0x81XX (XX 表示属性ID)
	属性ID:
	- 0 		标签状态(1B)
	- 1     	设备编号(4B,流水码)
	- 3			版本号(2B)
	- 4			型号(2B)
	- 5     	CPUID散列值(4B)
	- 6     	注册时间(4B)+当前时间(4B)
	- 7     	SYSTEMID(4B)
	- 8     	PING间隔(2B,10ms)
	- 9     	离线间隔(2B,10ms)
	- 0x0A     	重发次数(1B)
	- 0x0B     	低频配置信息=天线号(2B)+r_x(1B)+r_y(1B)
	- 0x10...    计步、温度、湿度、心率(等) ...

###10:2.4G发送数据（读写器）
	说明:
		读写器2.4G发送数据给标签
    设备发送:
		INS=0x06
		PARAMS= CMD(1B)+DATA(nB)

|CMD|说明|DATA|返回数据|
|-|-|-|-|
|指令||发送的数据||
|0x01| 格式化指令|[内容长度(1B)+信道(1B)]+指令类别码(1B)(0xA2)+指令码(1B)(0x00)+系统ID(4B)+CPU_ID(4B)+卡号(4B)+密码(8B)+初始化参数(16B)|[内容长度(1B)+信道(1B)]+指令类别码(1B)(0xA3)+指令码(1B)(0x00)+系统ID(4B)+CPU_ID(4B)+卡号(4B)+初始化参数(nB)|
|0x02| 参数读取|[[内容长度(1B)+信道(1B)]+指令类别码(1B)(0xA2)+指令码(1B)(0x02)+系统ID(4B)+CPU_ID(4B)+保留(4B)+属性ID(1B)+保留(1B)|[内容长度(1B)+信道(1B)]+指令类别码(1B)(0xA3)+指令码(1B)(0x02)+系统ID(4B)+CPU_ID(4B)+卡号(4B)+属性ID(1B)+属性类型/长度(1B)+属性值(...)|

	初始化参数说明：
	- 密码(8B)+初始化参数(16B)
	1. "FOFIAXYK"   执行格式化
	+SYSTEMID(4B)+注册时间(4B,秒)+PING间隔(1B,秒)+离线时间(1B,秒)+重发次数(1B)+保留(1B)
	2. "FOFIATIM"   设置时钟
	设备时间(4B)
	3. "FOFIASCH"   修改学校编号
	学校编号(2B)
	
	注： 协议头中的系统ID可以设置为0,这样就不检查系统ID,后面的指令均类似





